<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GitHub Game Lobby</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #020617;
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin: auto;
    }

    h1 {
      font-size: 1.875rem;
      font-weight: 800;
      letter-spacing: -0.05em;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #94a3b8;
      margin-bottom: 2rem;
      font-size: 0.95rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #94a3b8;
    }

    input[type="text"] {
      width: 100%;
      padding: 0.75rem;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 6px;
      color: white;
      font-size: 1rem;
      font-family: inherit;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    button {
      width: 100%;
      padding: 0.75rem;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover:not(:disabled) {
      background: #2563eb;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .lobby-list {
      margin-top: 2rem;
      display: grid;
      gap: 1rem;
    }

    .lobby-item {
      background: #0f172a;
      border: 1px solid #334155;
      padding: 1rem;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      transition: border-color 0.2s;
    }

    .lobby-item:hover {
      border-color: #3b82f6;
    }

    .lobby-name {
      font-weight: 700;
      display: block;
    }

    .lobby-type {
      font-size: 0.75rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    header {
      height: 4rem;
      border-bottom: 1px solid #334155;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px);
    }

    #gameCanvas {
      width: 100%;
      height: calc(100vh - 4rem);
      display: block;
    }

    .hud-controls {
      position: absolute;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      padding: 1rem 2rem;
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 2rem;
      pointer-events: none;
    }

    kbd {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      font-family: monospace;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // Configuration - Replace with your Replit deployment URL
    const API_BASE = window.location.origin.includes('replit.app') 
      ? window.location.origin 
      : 'https://' + window.location.host;

    let currentPlayer = null;
    let lobbies = [];
    let currentLobby = null;
    let ws = null;
    let remotePlayers = new Map();

    // Three.js State
    let scene, camera, renderer, localGroup;
    let keys = {};
    let yaw = 0, pitch = 0;

    async function init() {
      const stored = localStorage.getItem('currentPlayer');
      if (stored) currentPlayer = JSON.parse(stored);
      await loadLobbies();
      render();
    }

    async function loadLobbies() {
      try {
        const res = await fetch(`${API_BASE}/api/lobbies`);
        lobbies = await res.json();
      } catch (e) {
        console.error('Failed to load lobbies', e);
      }
    }

    async function joinLobby(lobby) {
      const name = document.getElementById('username')?.value || currentPlayer?.name;
      if (!name) return alert('Enter a name');

      try {
        const res = await fetch(`${API_BASE}/api/players`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, lobbyId: lobby.id })
        });
        
        if (!res.ok) throw new Error('Join failed');
        
        currentPlayer = await res.json();
        currentLobby = lobby;
        localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
        
        connectWS();
        render();
        initGame();
      } catch (e) {
        alert('Name taken or server error');
      }
    }

    function connectWS() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${API_BASE.replace(/^https?:\/\//, '')}/ws`);
      
      ws.onopen = () => {
        ws.send(JSON.stringify({
          type: 'joinLobby',
          playerId: currentPlayer.id,
          lobbyId: currentLobby.id
        }));
      };

      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'gameState') {
          msg.players.forEach(p => updateRemotePlayer(p));
        } else if (msg.type === 'playerUpdate') {
          updateRemotePlayer(msg.player);
        } else if (msg.type === 'playerLeft') {
          const mesh = remotePlayers.get(msg.payload.id);
          if (mesh) {
            scene.remove(mesh);
            remotePlayers.delete(msg.payload.id);
          }
        }
      };
    }

    function initGame() {
      setTimeout(() => {
        const canvas = document.getElementById('gameCanvas');
        if (!canvas) return;

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020617);
        
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        
        renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight - 64);

        const grid = new THREE.GridHelper(100, 100, 0x334155, 0x1e293b);
        scene.add(grid);

        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 7.5);
        scene.add(dirLight);

        localGroup = new THREE.Group();
        const body = new THREE.Mesh(
          new THREE.BoxGeometry(0.8, 1.8, 0.8),
          new THREE.MeshStandardMaterial({ color: 0x3b82f6 })
        );
        body.position.y = 0.9;
        localGroup.add(body);
        scene.add(localGroup);

        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);
        canvas.addEventListener('click', () => canvas.requestPointerLock());
        document.addEventListener('mousemove', e => {
          if (document.pointerLockElement === canvas) {
            yaw -= e.movementX * 0.002;
            pitch -= e.movementY * 0.002;
            pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
          }
        });

        animate();
      }, 0);
    }

    function updateRemotePlayer(p) {
      if (p.id === currentPlayer.id) return;
      let mesh = remotePlayers.get(p.id);
      if (!mesh) {
        mesh = new THREE.Group();
        const body = new THREE.Mesh(
          new THREE.BoxGeometry(0.8, 1.8, 0.8),
          new THREE.MeshStandardMaterial({ color: p.color || 0xef4444 })
        );
        body.position.y = 0.9;
        mesh.add(body);
        scene.add(mesh);
        remotePlayers.set(p.id, mesh);
      }
      if (p.position) mesh.position.set(p.position.x, p.position.y, p.position.z);
      if (p.rotation) mesh.rotation.y = p.rotation.y;
    }

    function animate() {
      requestAnimationFrame(animate);
      if (!localGroup) return;

      const speed = 0.1;
      const moveX = (keys['KeyA'] ? 1 : 0) - (keys['KeyD'] ? 1 : 0);
      const moveZ = (keys['KeyW'] ? 1 : 0) - (keys['KeyS'] ? 1 : 0);
      
      if (moveX !== 0 || moveZ !== 0) {
        const dir = new THREE.Vector3(moveX, 0, moveZ).applyAxisAngle(new THREE.Vector3(0, 1, 0), yaw).normalize();
        localGroup.position.add(dir.multiplyScalar(speed));
        
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'update',
            position: localGroup.position,
            rotation: { x: 0, y: yaw, z: 0 }
          }));
        }
      }

      camera.rotation.set(pitch, yaw, 0, 'YXZ');
      camera.position.copy(localGroup.position).add(new THREE.Vector3(0, 1.6, 0));
      renderer.render(scene, camera);
    }

    function render() {
      const app = document.getElementById('app');
      if (!currentLobby) {
        app.innerHTML = `
          <div class="card">
            <h1>GITHUB GAME</h1>
            <p class="subtitle">Join a lobby to enter the arena</p>
            <div class="form-group">
              <label>Your Name</label>
              <input type="text" id="username" value="${currentPlayer?.name || ''}" placeholder="Enter username...">
            </div>
            <div class="lobby-list">
              <label>Active Lobbies</label>
              ${lobbies.map(l => `
                <button class="lobby-item" onclick='joinLobby(${JSON.stringify(l)})'>
                  <span class="lobby-name">${l.name}</span>
                  <span class="lobby-type">${l.type}</span>
                </button>
              `).join('')}
            </div>
          </div>
        `;
      } else {
        app.innerHTML = `
          <header>
            <div>
              <h2 style="font-size: 0.8rem; font-weight: 900;">${currentLobby.name.toUpperCase()}</h2>
              <span style="font-size: 0.6rem; color: #64748b;">MULTIPLAYER ARENA</span>
            </div>
            <button style="width: auto; padding: 0.5rem 1rem; background: #ef4444;" onclick="location.reload()">LEAVE</button>
          </header>
          <main style="position: relative;">
            <canvas id="gameCanvas"></canvas>
            <div class="hud-controls">
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd>
                <span style="font-size: 0.6rem; font-weight: 800; color: #64748b;">MOVE</span>
              </div>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <kbd>CLICK</kbd>
                <span style="font-size: 0.6rem; font-weight: 800; color: #64748b;">LOOK</span>
              </div>
            </div>
          </main>
        `;
      }
    }

    init();
  </script>
</body>
</html>
