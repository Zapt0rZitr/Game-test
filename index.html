<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GitHub Game Lobby</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    body.dark {
      background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    body.dark .card {
      background: #1f1f1f;
      color: #e0e0e0;
    }

    h1 {
      font-size: 1.875rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #666;
      margin-bottom: 2rem;
      font-size: 0.95rem;
    }

    body.dark .subtitle {
      color: #999;
    }

    form {
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      font-family: inherit;
    }

    body.dark input[type="text"] {
      background: #2a2a2a;
      border-color: #444;
      color: #e0e0e0;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    button {
      width: 100%;
      padding: 0.625rem;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover:not(:disabled) {
      background: #1d4ed8;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    body.dark button {
      background: #3b82f6;
    }

    body.dark button:hover:not(:disabled) {
      background: #2563eb;
    }

    .players-section {
      background: #f9f9f9;
      border-radius: 6px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    body.dark .players-section {
      background: #2a2a2a;
    }

    .players-section h3 {
      font-weight: 600;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .players-list {
      list-style: none;
    }

    .players-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid #eee;
    }

    body.dark .players-list li {
      border-bottom-color: #444;
    }

    .players-list li:last-child {
      border-bottom: none;
    }

    .time {
      font-size: 0.8rem;
      color: #999;
    }

    body.dark .time {
      color: #666;
    }

    .empty-state {
      color: #999;
      font-size: 0.9rem;
    }

    body.dark .empty-state {
      color: #666;
    }

    .lobby-view {
      max-width: 800px;
    }

    .lobby-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .lobby-header h1 {
      margin: 0;
    }

    .leave-btn {
      background: #ef4444;
      padding: 0.5rem 1rem;
      width: auto;
    }

    .leave-btn:hover {
      background: #dc2626;
    }

    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .player-card {
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    body.dark .player-card {
      background: #1f1f1f;
      border-color: #333;
    }

    .player-info p:first-child {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .player-info p:last-child {
      font-size: 0.8rem;
      color: #999;
    }

    body.dark .player-info p:last-child {
      color: #666;
    }

    .you-badge {
      background: #2563eb;
      color: white;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }

    .toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: #333;
      color: white;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.error {
      background: #dc2626;
    }

    .toast.success {
      background: #059669;
    }

    .connection-status {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ef4444;
      margin-left: 0.5rem;
    }

    .connection-status.connected {
      background: #10b981;
    }
  </style>
</head>
<body>
  <div id="app"></div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.158/build/three.module.js';
import { PointerLockControls } from 'https://cdn.jsdelivr.net/npm/three@0.158/examples/jsm/controls/PointerLockControls.js';

const API_BASE = 'https://node-weaver--Zapt0rWut.replit.app';

let currentPlayer = null;
let players = {};
let ws = null;

// ======================
// THREE.JS STATE
// ======================
let scene, camera, renderer, controls;
let playerMesh;
let move = { forward: false, backward: false, left: false, right: false };
let velocity = new THREE.Vector3();
let lastSent = 0;

// ======================
// INIT
// ======================
initFromStorage();
connectWebSocket();
renderLobby();

// ======================
// LOBBY
// ======================
async function joinLobby(name) {
  const res = await fetch(`${API_BASE}/api/players`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name })
  });

  if (!res.ok) {
    alert('Name already taken');
    return;
  }

  currentPlayer = await res.json();
  localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
  renderGame();
}

function renderLobby() {
  document.getElementById('app').innerHTML = `
    <div class="card">
      <h1>GitHub Game</h1>
      <form onsubmit="event.preventDefault(); joinLobby(name.value)">
        <input id="name" placeholder="Name" required />
        <button>Join Game</button>
      </form>
    </div>
  `;
}

window.joinLobby = joinLobby;

// ======================
// GAME
// ======================
function renderGame() {
  document.getElementById('app').innerHTML = '';
  initThree();
  animate();
}

function initThree() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0xaaaaaa);

  camera = new THREE.PerspectiveCamera(
    75,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
  );

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Floor
  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(100, 100),
    new THREE.MeshStandardMaterial({ color: 0x777777 })
  );
  floor.rotation.x = -Math.PI / 2;
  scene.add(floor);

  // Light
  scene.add(new THREE.HemisphereLight(0xffffff, 0x444444));
  const dir = new THREE.DirectionalLight(0xffffff);
  dir.position.set(5, 10, 2);
  scene.add(dir);

  // Player cube
  const color = new THREE.Color().setHSL(Math.random(), 0.7, 0.5);
  playerMesh = new THREE.Mesh(
    new THREE.BoxGeometry(1, 1, 1),
    new THREE.MeshStandardMaterial({ color })
  );
  scene.add(playerMesh);

  // Name label
  playerMesh.add(makeNameSprite(currentPlayer.name));

  // Camera & controls
  controls = new PointerLockControls(camera, document.body);
  camera.position.y = 1.6;
  playerMesh.add(camera);

  document.body.addEventListener('click', () => controls.lock());

  // Input
  document.addEventListener('keydown', e => setMove(e.code, true));
  document.addEventListener('keyup', e => setMove(e.code, false));
}

function setMove(code, value) {
  if (code === 'KeyW') move.forward = value;
  if (code === 'KeyS') move.backward = value;
  if (code === 'KeyA') move.left = value;
  if (code === 'KeyD') move.right = value;
}

// ======================
// NETWORK
// ======================
function connectWebSocket() {
  const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${protocol}://${API_BASE.replace(/^https?:\/\//, '')}/ws`);

  ws.onmessage = e => {
    const msg = JSON.parse(e.data);

    if (msg.type === 'state') {
      for (const id in msg.players) {
        if (id === currentPlayer?.id) continue;
        updateRemotePlayer(id, msg.players[id]);
      }
    }

    if (msg.type === 'left') {
      scene.remove(players[msg.id]);
      delete players[msg.id];
    }
  };
}

function sendState() {
  if (!ws || ws.readyState !== 1) return;

  ws.send(JSON.stringify({
    type: 'update',
    position: playerMesh.position,
    rotation: playerMesh.rotation.y
  }));
}

function updateRemotePlayer(id, data) {
  if (!players[id]) {
    const mesh = new THREE.Mesh(
      new THREE.BoxGeometry(1, 1, 1),
      new THREE.MeshStandardMaterial({ color: 0x00ffcc })
    );
    mesh.add(makeNameSprite(data.name));
    scene.add(mesh);
    players[id] = mesh;
  }

  players[id].position.set(
    data.position.x,
    data.position.y,
    data.position.z
  );
  players[id].rotation.y = data.rotation;
}

// ======================
// LOOP
// ======================
function animate() {
  requestAnimationFrame(animate);

  const speed = 0.1;
  velocity.set(0, 0, 0);

  if (move.forward) velocity.z -= speed;
  if (move.backward) velocity.z += speed;
  if (move.left) velocity.x -= speed;
  if (move.right) velocity.x += speed;

  controls.moveRight(velocity.x);
  controls.moveForward(velocity.z);

  playerMesh.position.copy(controls.getObject().position);

  if (performance.now() - lastSent > 50) {
    sendState();
    lastSent = performance.now();
  }

  renderer.render(scene, camera);
}

// ======================
// UTILS
// ======================
function makeNameSprite(name) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  ctx.font = '24px sans-serif';
  ctx.fillStyle = 'white';
  ctx.fillText(name, 10, 30);

  const texture = new THREE.CanvasTexture(canvas);
  const sprite = new THREE.Sprite(
    new THREE.SpriteMaterial({ map: texture })
  );
  sprite.scale.set(2, 1, 1);
  sprite.position.y = 1.2;
  return sprite;
}

function initFromStorage() {
  const stored = localStorage.getItem('currentPlayer');
  if (stored) currentPlayer = JSON.parse(stored);
}
</script>

</body>
</html>
