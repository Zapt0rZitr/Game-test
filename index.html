<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Three.js Multiplayer Lobbies</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; background: #222; color: white; }
    #lobby-selection { position: absolute; top: 20px; left: 20px; background: #333; padding: 20px; border-radius: 8px; z-index: 100; }
    #lobby-selection h1 { margin-bottom: 10px; }
    #lobby-list { list-style: none; padding: 0; }
    #lobby-list li { cursor: pointer; margin-bottom: 5px; padding: 8px; background: #444; border-radius: 4px; transition: background 0.2s; }
    #lobby-list li:hover { background: #555; color: #0af; }
    #leave-btn { position: absolute; top: 20px; right: 20px; padding: 10px; background: #f44; border: none; border-radius: 5px; cursor: pointer; z-index: 100; color: white; font-weight: bold; }
  </style>
</head>
<body>
  <div id="lobby-selection">
    <h1>Select Lobby</h1>
    <ul id="lobby-list"></ul>
  </div>
  <button id="leave-btn" style="display:none;">Leave Lobby</button>

  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/PointerLockControls.js"></script>
  <script>
    const API_BASE = 'https://node-weaver--Zapt0rWut.replit.app'; // Your backend URL
    let ws;
    let currentPlayer = null;
    let lobbyId = null;
    let scene, camera, renderer, controls;
    let cubes = {};
    let playerCube;
    let clock = new THREE.Clock();
    let keys = {};
    let speed = 5;

    // Initialize player from storage or prompt for name
    function initPlayer() {
      const stored = localStorage.getItem('currentPlayer');
      if (stored) {
        currentPlayer = JSON.parse(stored);
        loadLobbies();
      } else {
        const name = prompt('Enter your player name');
        if (!name) return alert('Name required');
        joinLobbyAPI(name);
      }
    }

    async function joinLobbyAPI(name) {
      try {
        const res = await fetch(`${API_BASE}/api/players`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ name })
        });
        if (!res.ok) throw new Error('Failed to join');
        currentPlayer = await res.json();
        localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
        loadLobbies();
      } catch(e) { alert('Failed to join lobby'); console.error(e); }
    }

    async function loadLobbies() {
      try {
        const res = await fetch(`${API_BASE}/api/lobbies`);
        let lobbies = await res.json();

        // If no lobbies exist, create one by default for testing
        if(lobbies.length === 0) {
          await fetch(`${API_BASE}/api/lobbies`, {
            method: 'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({name: 'Default Lobby', type: 'threejs'})
          });
          lobbies = await fetch(`${API_BASE}/api/lobbies`).then(r=>r.json());
        }

        const list = document.getElementById('lobby-list');
        list.innerHTML = '';
        lobbies.forEach(lobby=>{
          const li = document.createElement('li');
          li.textContent = lobby.name;
          li.onclick = () => joinLobby(lobby.id);
          list.appendChild(li);
        });
      } catch(e) {
        console.error('Failed to load lobbies:', e);
      }
    }

    function joinLobby(id) {
      lobbyId = id;
      document.getElementById('lobby-selection').style.display = 'none';
      document.getElementById('leave-btn').style.display = 'block';
      initThreeJS();
      connectWebSocket();
    }

    document.getElementById('leave-btn').onclick = async () => {
      if(!currentPlayer) return;
      try {
        await fetch(`${API_BASE}/api/players/${currentPlayer.id}`, {method:'DELETE'});
      } catch(e) {
        console.error('Failed to leave:', e);
      }
      localStorage.removeItem('currentPlayer');
      window.location.reload();
    };

    function initThreeJS() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({antialias:true});
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      const light = new THREE.DirectionalLight(0xffffff,1);
      light.position.set(5,10,5);
      scene.add(light);

      const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(100,100),
        new THREE.MeshStandardMaterial({color:0x555555})
      );
      ground.rotation.x = -Math.PI/2;
      scene.add(ground);

      controls = new THREE.PointerLockControls(camera, document.body);
      document.body.addEventListener('click', ()=>controls.lock());
      camera.position.y = 1.5;

      document.addEventListener('keydown', e=>keys[e.key.toLowerCase()]=true);
      document.addEventListener('keyup', e=>keys[e.key.toLowerCase()]=false);

      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();
      updatePlayer(delta);
      renderer.render(scene, camera);
    }

    function updatePlayer(delta) {
      if(!controls || !controls.isLocked) return;
      
      let velocity = new THREE.Vector3();
      if(keys['w']) velocity.z -= speed*delta;
      if(keys['s']) velocity.z += speed*delta;
      if(keys['a']) velocity.x -= speed*delta;
      if(keys['d']) velocity.x += speed*delta;

      controls.moveRight(velocity.x);
      controls.moveForward(velocity.z);

      if(ws && ws.readyState===WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type:'update',
          position:{x:camera.position.x,y:camera.position.y,z:camera.position.z},
          rotation:{x:camera.rotation.x,y:camera.rotation.y,z:camera.rotation.z}
        }));
      }
    }

    function addPlayerCube(player) {
      if(cubes[player.id]) return;
      const geo = new THREE.BoxGeometry(1,1,1);
      const mat = new THREE.MeshStandardMaterial({color: player.color || Math.random()*0xffffff});
      const cube = new THREE.Mesh(geo, mat);
      
      // Initial position
      const pos = player.position || {x:0, y:0.5, z:0};
      cube.position.set(pos.x, pos.y, pos.z);
      
      scene.add(cube);
      cubes[player.id] = cube;
    }

    function connectWebSocket() {
      const protocol = window.location.protocol==='https:'?'wss:':'ws:';
      const wsHost = API_BASE.replace(/^https?:\/\//,'');
      ws = new WebSocket(`${protocol}//${wsHost}/ws`);
      
      ws.onopen = () => {
        ws.send(JSON.stringify({type:'joinLobby',playerId:currentPlayer.id,lobbyId}));
      };
      
      ws.onmessage = (event)=>{
        const msg = JSON.parse(event.data);
        if(msg.type==='gameState') {
          msg.players.forEach(addPlayerCube);
        }
        if(msg.type==='playerJoined') {
          addPlayerCube(msg.payload);
        }
        if(msg.type==='playerUpdate') {
          const p = msg.player;
          if(p.id!==currentPlayer.id) {
            if(!cubes[p.id]) {
              addPlayerCube(p);
            } else {
              cubes[p.id].position.set(p.position.x, p.position.y, p.position.z);
              cubes[p.id].rotation.set(p.rotation.x, p.rotation.y, p.rotation.z);
            }
          }
        }
        if(msg.type==='playerLeft') {
          if(cubes[msg.payload.id]) {
            scene.remove(cubes[msg.payload.id]);
            delete cubes[msg.payload.id];
          }
        }
      };
      ws.onclose = ()=>console.log('Disconnected');
    }

    initPlayer();
  </script>
</body>
</html>
