<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multiplayer Three.js Lobby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      font-family: sans-serif;
    }

    #ui {
      position: fixed;
      top: 10px;
      left: 10px;
      color: white;
      z-index: 10;
      background: rgba(0,0,0,0.5);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="ui">Click to lock mouse<br>WASD to move</div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
  <script>
    /***********************
     * CONFIG
     ***********************/
    const API_BASE = 'https://node-weaver--Zapt0rWut.replit.app'; // Change this to your Replit backend URL    const LOBBY_ID = 3;

    const storedPlayer = JSON.parse(localStorage.getItem("currentPlayer"));
    if (!storedPlayer) {
      alert("No player found. Join lobby first.");
      location.href = "/";
    }

    /***********************
     * THREE.JS SETUP
     ***********************/
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x202020);

    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    camera.position.y = 1.6;

    scene.add(new THREE.GridHelper(100, 100));

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(5, 10, 5);
    scene.add(light);

    scene.add(new THREE.AmbientLight(0xffffff, 0.4));

    /***********************
     * PLAYER
     ***********************/
    const playerGeo = new THREE.BoxGeometry(1, 1, 1);
    const playerMat = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
    const localPlayer = new THREE.Mesh(playerGeo, playerMat);
    scene.add(localPlayer);

    /***********************
     * OTHER PLAYERS
     ***********************/
    const remotePlayers = new Map();

    function spawnOrUpdatePlayer(p) {
      if (p.id === storedPlayer.id) return;

      let mesh = remotePlayers.get(p.id);

      if (!mesh) {
        const mat = new THREE.MeshStandardMaterial({ color: p.color || 0xff0000 });
        mesh = new THREE.Mesh(playerGeo, mat);
        scene.add(mesh);
        remotePlayers.set(p.id, mesh);
      }

      mesh.position.set(p.position.x, p.position.y, p.position.z);
      mesh.rotation.set(p.rotation.x, p.rotation.y, p.rotation.z);
    }

    function removePlayer(id) {
      const mesh = remotePlayers.get(id);
      if (mesh) {
        scene.remove(mesh);
        remotePlayers.delete(id);
      }
    }

    /***********************
     * INPUT
     ***********************/
    const keys = {};

    document.addEventListener("keydown", e => keys[e.code] = true);
    document.addEventListener("keyup", e => keys[e.code] = false);

    document.body.addEventListener("click", () => {
      document.body.requestPointerLock();
    });

    document.addEventListener("mousemove", e => {
      if (document.pointerLockElement) {
        camera.rotation.y -= e.movementX * 0.002;
        camera.rotation.x -= e.movementY * 0.002;
        camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
      }
    });

    /***********************
     * MOVEMENT
     ***********************/
    function updateMovement() {
      const speed = 0.1;
      const dir = new THREE.Vector3();

      if (keys["KeyW"]) dir.z -= speed;
      if (keys["KeyS"]) dir.z += speed;
      if (keys["KeyA"]) dir.x -= speed;
      if (keys["KeyD"]) dir.x += speed;

      dir.applyAxisAngle(new THREE.Vector3(0,1,0), camera.rotation.y);
      localPlayer.position.add(dir);

      camera.position.copy(localPlayer.position).add(new THREE.Vector3(0, 1.6, 0));
    }

    /***********************
     * WEBSOCKET
     ***********************/
    const protocol = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${protocol}://${API_BASE.replace(/^https?:\/\//, "")}/ws`);

    ws.onopen = () => {
      ws.send(JSON.stringify({
        type: "joinLobby",
        playerId: storedPlayer.id,
        lobbyId: LOBBY_ID
      }));
    };

    ws.onmessage = e => {
      const msg = JSON.parse(e.data);

      if (msg.type === "gameState") {
        msg.players.forEach(spawnOrUpdatePlayer);
      }

      if (msg.type === "playerUpdate") {
        spawnOrUpdatePlayer(msg.player);
      }

      if (msg.type === "playerLeft") {
        removePlayer(msg.payload.id);
      }
    };

    function sendUpdate() {
      if (ws.readyState !== WebSocket.OPEN) return;

      ws.send(JSON.stringify({
        type: "update",
        position: {
          x: localPlayer.position.x,
          y: localPlayer.position.y,
          z: localPlayer.position.z
        },
        rotation: {
          x: camera.rotation.x,
          y: camera.rotation.y,
          z: 0
        }
      }));
    }

    setInterval(sendUpdate, 50);

    /***********************
     * LOOP
     ***********************/
    function animate() {
      requestAnimationFrame(animate);
      updateMovement();
      renderer.render(scene, camera);
    }

    animate();

    /***********************
     * RESIZE
     ***********************/
    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
