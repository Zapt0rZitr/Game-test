<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Game Lobby</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
      }
    }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        kbd { font-family: monospace; }
        .bg-slate-950 { background-color: #020617; }
    </style>
</head>
<body class="bg-slate-950 text-white overflow-hidden">
    <div id="app" class="h-screen w-full flex flex-col"></div>

<script type="module">
    import { startGame, stopGame } from './game.js';

    const REPLIT_URL = window.location.host.includes('replit.dev') 
        ? window.location.host 
        : 'c0a57a38-5e07-47e2-832b-3893a6a45c9d-00-1onb29g72tmp2.picard.replit.dev';

    const API_BASE = `https://${REPLIT_URL}`;
    const WS_BASE = `wss://${REPLIT_URL}`;

    let state = {
        currentPlayer: JSON.parse(localStorage.getItem('currentPlayer') || 'null'),
        currentLobby: null,
        lobbies: [],
        remotePlayers: [],
        nameInput: '',
        newLobbyName: ''
    };

    function render() {
        const app = document.getElementById('app');
        if (!state.currentLobby) {
            app.innerHTML = renderLobbyBrowser();
        } else {
            app.innerHTML = renderGameView();
            startGame({
                canvasId: 'gameCanvas',
                wsBase: WS_BASE,
                state
            });
        }
        attachEventListeners();
    }

    async function leaveLobby() {
        if (state.currentPlayer) {
            await fetch(`${API_BASE}/api/players/${state.currentPlayer.id}`, { method: 'DELETE' });
        }
        stopGame();
        state.currentPlayer = null;
        state.currentLobby = null;
        state.remotePlayers = [];
        localStorage.removeItem('currentPlayer');
        render();
    }

    function updatePlayerCount() {
        const el = document.getElementById('playerCount');
        if (el) el.textContent = `${state.remotePlayers.length + 1} Players Online`;
    }

    window.updatePlayerCount = updatePlayerCount; // exposed for game.js

    fetchLobbies();
</script>
</body>
</html>
