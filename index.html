<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Three.js Multiplayer Lobbies</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; background: #222; color: white; }
    #lobby-selection { position: absolute; top: 20px; left: 20px; background: #333; padding: 20px; border-radius: 8px; }
    #lobby-selection h1 { margin-bottom: 10px; }
    #lobby-list li { cursor: pointer; margin-bottom: 5px; }
    #lobby-list li:hover { color: #0af; }
    #leave-btn { position: absolute; top: 20px; right: 20px; padding: 10px; background: #f44; border: none; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="lobby-selection">
    <h1>Select Lobby</h1>
    <ul id="lobby-list"></ul>
  </div>
  <button id="leave-btn" style="display:none;">Leave Lobby</button>

  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/PointerLockControls.js"></script>
  <script>
    const API_BASE = 'https://node-weaver--Zapt0rWut.replit.app'; // Your backend URL
    let ws;
    let currentPlayer = null;
    let lobbyId = null;
    let scene, camera, renderer, controls;
    let cubes = {};
    let playerCube;
    let clock = new THREE.Clock();
    let keys = {};
    let speed = 5;

    // Initialize player from storage or prompt for name
    function initPlayer() {
      const stored = localStorage.getItem('currentPlayer');
      if (stored) {
        currentPlayer = JSON.parse(stored);
        loadLobbies();
      } else {
        const name = prompt('Enter your player name');
        if (!name) return alert('Name required');
        joinLobbyAPI(name);
      }
    }

    async function joinLobbyAPI(name) {
      try {
        const res = await fetch(`${API_BASE}/api/players`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ name })
        });
        if (!res.ok) throw new Error('Failed to join');
        currentPlayer = await res.json();
        localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
        loadLobbies();
      } catch(e) { alert('Failed to join lobby'); console.error(e); }
    }

    async function loadLobbies() {
      const res = await fetch(`${API_BASE}/api/lobbies`);
      let lobbies = await res.json();

      // If no lobbies exist, create 3 by default
      if(lobbies.length === 0) {
        for(let i=1;i<=3;i++) {
          const create = await fetch(`${API_BASE}/api/lobbies`, {
            method: 'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({name:`Lobby ${i}`})
          });
        }
        lobbies = await fetch(`${API_BASE}/api/lobbies`).then(r=>r.json());
      }

      const list = document.getElementById('lobby-list');
      list.innerHTML = '';
      lobbies.forEach(lobby=>{
        const li = document.createElement('li');
        li.textContent = lobby.name;
        li.onclick = () => joinLobby(lobby.id);
        list.appendChild(li);
      });
    }

    function joinLobby(id) {
      lobbyId = id;
      document.getElementById('lobby-selection').style.display = 'none';
      document.getElementById('leave-btn').style.display = 'block';
      initThreeJS();
      connectWebSocket();
    }

    document.getElementById('leave-btn').onclick = async () => {
      if(!currentPlayer) return;
      await fetch(`${API_BASE}/api/players/${currentPlayer.id}`, {method:'DELETE'});
      localStorage.removeItem('currentPlayer');
      window.location.reload();
    };

    function initThreeJS() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({antialias:true});
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      const light = new THREE.DirectionalLight(0xffffff,1);
      light.position.set(5,10,5);
      scene.add(light);

      const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(100,100),
        new THREE.MeshStandardMaterial({color:0x555555})
      );
      ground.rotation.x = -Math.PI/2;
      scene.add(ground);

      controls = new THREE.PointerLockControls(camera, document.body);
      document.body.addEventListener('click', ()=>controls.lock());
      camera.position.y = 1.5;

      document.addEventListener('keydown', e=>keys[e.key.toLowerCase()]=true);
      document.addEventListener('keyup', e=>keys[e.key.toLowerCase()]=false);

      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();
      updatePlayer(delta);
      renderer.render(scene, camera);
    }

    function updatePlayer(delta) {
      if(!playerCube) return;
      let velocity = new THREE.Vector3();
      if(keys['w']) velocity.z -= speed*delta;
      if(keys['s']) velocity.z += speed*delta;
      if(keys['a']) velocity.x -= speed*delta;
      if(keys['d']) velocity.x += speed*delta;

      controls.moveRight(velocity.x);
      controls.moveForward(velocity.z);

      playerCube.position.copy(camera.position);

      if(ws && ws.readyState===WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type:'update',
          position:{x:camera.position.x,y:camera.position.y,z:camera.position.z},
          rotation:{x:camera.rotation.x,y:camera.rotation.y,z:camera.rotation.z}
        }));
      }
    }

    function addPlayerCube(player) {
      if(cubes[player.id]) return;
      const geo = new THREE.BoxGeometry(1,1,1);
      const mat = new THREE.MeshStandardMaterial({color:player.color||Math.random()*0xffffff});
      const cube = new THREE.Mesh(geo, mat);
      cube.position.set(player.position.x, player.position.y, player.position.z);
      scene.add(cube);
      cubes[player.id] = cube;
      if(player.id===currentPlayer.id) playerCube = cube;
    }

    function connectWebSocket() {
      const protocol = window.location.protocol==='https:'?'wss:':'ws:';
      ws = new WebSocket(`${protocol}//${API_BASE.replace(/^https?:\/\//,'')}/ws`);
      ws.onopen = () => {
        ws.send(JSON.stringify({type:'joinLobby',playerId:currentPlayer.id,lobbyId}));
      };
      ws.onmessage = (event)=>{
        const msg = JSON.parse(event.data);
        if(msg.type==='gameState') msg.players.forEach(addPlayerCube);
        if(msg.type==='playerUpdate') {
          const p = msg.player;
          if(p.id!==currentPlayer.id && cubes[p.id]) {
            cubes[p.id].position.set(p.position.x,p.position.y,p.position.z);
          }
        }
      };
      ws.onclose = ()=>console.log('Disconnected');
    }

    initPlayer();
  </script>
</body>
</html>
